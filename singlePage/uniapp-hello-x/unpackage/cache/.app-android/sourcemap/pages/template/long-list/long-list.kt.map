{"version":3,"sources":["pages/template/long-list/long-list.uvue","pages/component/unicloud-db-contacts/list.uvue?type=page","pages/template/long-list/long-list.uvue?type=page"],"sourcesContent":["<template>\n  <scroll-view ref=\"pageScrollView\" class=\"page\" :rebound=\"false\"\n    @startnestedscroll=\"onStartNestedScroll\" @nestedprescroll=\"onNestedPreScroll\">\n    <view ref=\"header\" class=\"search-bar\">\n      <input placeholder=\"搜索...\" maxlength=\"-1\"/>\n    </view>\n    <view class=\"swiper-list\">\n      <scroll-view ref=\"tabScroll\" class=\"swiper-tabs\" direction=\"horizontal\" :show-scrollbar=\"false\">\n        <view class=\"flex-row\" style=\"align-self: flex-start;\">\n          <text ref=\"swipertab\" space=\"nbsp\" class=\"swiper-tabs-item\" :class=\"swiperIndex==index ? 'swiper-tabs-item-active' : ''\"\n            v-for=\"(item, index) in swiperList\" :key=\"index\" @click=\"onTabClick(index)\">\n            {{item.name}}\n          </text>\n        </view>\n        <view ref=\"indicator\" class=\"swiper-tabs-indicator\"></view>\n      </scroll-view>\n      <swiper ref=\"swiper\" class=\"swiper-view\" :current=\"swiperIndex\" @transition=\"onSwiperTransition\"\n        @animationfinish=\"onSwiperAnimationfinish\">\n        <swiper-item class=\"swiper-item\" v-for=\"(item, index) in swiperList\" :key=\"index\">\n          <long-page ref=\"longPage\" :type=\"item.type\" :preload=\"item.preload\"></long-page>\n        </swiper-item>\n      </swiper>\n    </view>\n  </scroll-view>\n</template>\n\n<script>\n  import longPage from './long-list-page.uvue';\n\n  type SwiperTabsItem = {\n    x : number,\n    w : number\n  }\n\n  type SwiperViewItem = {\n    type : string,\n    name : string,\n    preload : boolean,\n  }\n\n  /**\n   * 根据权重在两个值之间执行线性插值.\n   * @constructor\n   * @param {number} value1 - 第一个值，该值应为下限.\n   * @param {number} value2 - 第二个值，该值应为上限.\n   * @param {number} amount - 应介于 0 和 1 之间，指示内插的权重.\n   * @returns {number} 内插值\n   */\n  function lerpNumber(value1 : number, value2 : number, amount : number) : number {\n    return (value1 + (value2 - value1) * amount)\n  }\n\n  export default {\n    components: {\n      longPage\n    },\n    data() {\n      return {\n        swiperList: [\n          {\n            type: 'UpdatedDate',\n            name: '最新上架',\n            preload: true\n          },\n          {\n            type: 'FreeHot',\n            name: '免费热榜',\n            preload: false\n          },\n          {\n            type: 'PaymentHot',\n            name: '付费热榜',\n            preload: false\n          },\n          {\n            type: 'HotList',\n            name: '热门总榜',\n            preload: false\n          }\n        ] as SwiperViewItem[],\n        swiperIndex: 0,\n        pageScrollView: null as null | UniElement,\n        headerHeight: 0,\n        animationFinishIndex: 0,\n        tabScrollView: null as null | UniElement,\n        indicatorNode: null as null | UniElement,\n        swiperWidth: 0,\n        swiperTabsRect: [] as SwiperTabsItem[]\n      }\n    },\n    onReady() {\n      this.pageScrollView = this.$refs['pageScrollView'] as UniElement;\n      this.headerHeight = (this.$refs['header'] as UniElement).offsetHeight\n      this.swiperWidth = (this.$refs['swiper'] as UniElement).getBoundingClientRect().width\n      this.tabScrollView = this.$refs['tabScroll'] as UniElement\n      this.indicatorNode = this.$refs['indicator'] as UniElement\n      this.cacheTabItemsSize()\n      this.updateTabIndicator(this.swiperIndex, this.swiperIndex, 1)\n    },\n    onPullDownRefresh() {\n      (this.$refs[\"longPage\"]! as ComponentPublicInstance[])[this.swiperIndex].$callMethod('refreshData', () => {\n        uni.stopPullDownRefresh()\n      })\n    },\n    methods: {\n      // TODO\n      onStartNestedScroll(_ : StartNestedScrollEvent) : boolean {\n        return true\n      },\n      onNestedPreScroll(event : NestedPreScrollEvent) {\n        const deltaY = event.deltaY\n        const scrollTop = this.pageScrollView!.scrollTop\n\n        // 优先处理父容器滚动，父容器不能滚动时滚动子\n\n        if (deltaY > 0) {\n          // 向上滚动，如果父容器 header scrollTop < offsetHeight，先滚动父容器\n          if (scrollTop < this.headerHeight) {\n            const difference = this.headerHeight - scrollTop - deltaY\n            if (difference > 0) {\n              this.pageScrollView!.scrollBy(event.deltaX, deltaY)\n              event.consumed(event.deltaX, deltaY)\n            } else {\n              const top : number = deltaY + difference\n              event.consumed(event.deltaX, top.toFloat())\n              this.pageScrollView!.scrollBy(event.deltaX, top.toFloat())\n            }\n          }\n        } else if (deltaY < 0) {\n          // 向下滚动，如果父容器 scrollTop > 0，通知子被父容器消耗，然后滚动到 0\n          if (scrollTop > 0) {\n            event.consumed(event.deltaX, deltaY)\n            this.pageScrollView!.scrollBy(event.deltaX, deltaY)\n          }\n        }\n      },\n      onTabClick(index : number) {\n        this.setSwiperIndex(index, false)\n      },\n      onSwiperTransition(e : SwiperTransitionEvent) {\n        // 微信 skyline 每项完成触发 Animationfinish，偏移值重置\n        // 微信 webview 全部完成触发 Animationfinish，偏移值累加\n        // 在滑动到下一个项的过程中，再次反向滑动，偏移值递减\n        // uni-app-x 和微信 webview 行为一致\n\n        const offset_x = e.detail.dx\n\n        // 计算当前索引并重置差异\n        const current_offset_x = offset_x % this.swiperWidth\n        const current_offset_i = offset_x / this.swiperWidth\n        const current_index = this.animationFinishIndex + parseInt(current_offset_i + '')\n\n        // 计算目标索引及边界检查\n        let move_to_index = current_index\n        if (current_offset_x > 0 && move_to_index < this.swiperList.length - 1) {\n          move_to_index += 1\n        } else if (current_offset_x < 0 && move_to_index > 0) {\n          move_to_index -= 1\n        }\n\n        // 计算偏移百分比\n        const percentage = Math.abs(current_offset_x) / this.swiperWidth\n\n        // 通知更新指示线\n        this.updateTabIndicator(current_index, move_to_index, percentage)\n\n        // 首次可见时初始化数据\n        this.initSwiperItemData(move_to_index)\n      },\n      onSwiperAnimationfinish(e : SwiperAnimationFinishEvent) {\n        this.setSwiperIndex(e.detail.current, true)\n        this.animationFinishIndex = e.detail.current\n        console.log('this.animationFinishIndex', e.detail.current);\n      },\n      cacheTabItemsSize() {\n        this.swiperTabsRect.length = 0\n        const tabs = this.$refs[\"swipertab\"] as UniElement[]\n        tabs.forEach((node) => {\n          this.swiperTabsRect.push({\n            x: node.offsetLeft,\n            w: node.offsetWidth\n          } as SwiperTabsItem)\n        })\n      },\n      setSwiperIndex(index : number, updateIndicator : boolean) {\n        if (this.swiperIndex === index) {\n          return\n        }\n\n        this.swiperIndex = index\n\n        this.initSwiperItemData(index)\n\n        if (updateIndicator) {\n          this.updateTabIndicator(index, index, 1)\n        }\n      },\n      updateTabIndicator(current_index : number, move_to_index : number, percentage : number) {\n        const current_size = this.swiperTabsRect[current_index]\n        const move_to_size = this.swiperTabsRect[move_to_index]\n\n        // 计算指示线 左边距 和 宽度 在移动过程中的线性值\n        const indicator_line_x = lerpNumber(current_size.x, move_to_size.x, percentage)\n        const indicator_line_w = lerpNumber(current_size.w, move_to_size.w, percentage)\n\n        // 更新指示线\n\n        const x = indicator_line_x + indicator_line_w / 2\n        this.indicatorNode?.style?.setProperty('transform', `translateX(${x}px) scaleX(${indicator_line_w})`)\n\n\n\n\n\n\n\n\n        // 滚动到水平中心位置\n        const scroll_x = x - this.swiperWidth / 2\n        if(this.tabScrollView != null){\n          this.tabScrollView!.scrollLeft = scroll_x\n        }\n      },\n      initSwiperItemData(index : number) {\n        if (!this.swiperList[index].preload) {\n          this.swiperList[index].preload = true;\n          (this.$refs[\"longPage\"]! as ComponentPublicInstance[])[index].$callMethod('loadData', null)\n        }\n      }\n    }\n  }\n</script>\n\n<style>\n  .flex-row {\n    flex-direction: row;\n  }\n\n  .page {\n    flex: 1;\n  }\n\n  .search-bar {\n    padding: 10px;\n  }\n\n  .swiper-list {\n    height: 100%;\n\n\n\n  }\n\n  .swiper-tabs {\n    background-color: #ffffff;\n    flex-direction: column;\n  }\n\n  .swiper-tabs-item {\n    color: #555;\n    font-size: 16px;\n    padding: 12px 25px;\n    white-space: nowrap;\n  }\n\n  .swiper-tabs-item-active {\n    color: #007AFF;\n  }\n\n  .swiper-tabs-indicator {\n    width: 1px;\n    height: 2px;\n    background-color: #007AFF;\n  }\n\n  .swiper-view {\n    flex: 1;\n  }\n\n  .swiper-item {\n    flex: 1;\n  }\n</style>\n",null,null],"names":[],"mappings":"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"}