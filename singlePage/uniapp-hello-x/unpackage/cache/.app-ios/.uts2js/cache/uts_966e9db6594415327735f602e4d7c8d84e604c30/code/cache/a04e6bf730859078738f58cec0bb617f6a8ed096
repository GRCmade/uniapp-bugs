{"code":"import { defineComponent } from \"vue\";\n/**\n * 使用限制\n * - 容器大小变动时未刷新缓存的子元素大小\n * - 不支持设置初始滚动位置\n * - list数据内每一项不可以是基础类型\n * - item不支持设置margin，会导致计算位置不准确\n */\n/**\n * recycle-view 虚拟长列表组件\n * @description 用于超长列表的展示\n * @property {any[]} list 列表所有数据\n */\nexport default defineComponent({\n    name: \"uni-recycle-view\",\n    props: {\n        list: {\n            type: Array,\n            default: []\n        }\n    },\n    watch: {\n        list: {\n            handler(list) {\n                this.cachedSize.forEach((_, key = null) => {\n                    if (!list.includes(key)) {\n                        this.cachedSize.delete(key);\n                    }\n                });\n            },\n            deep: true\n        },\n        defaultItemSize() {\n            this.rearrange(this.lastScrollTop);\n        }\n    },\n    data() {\n        return {\n            items: [],\n            containerTop: 0,\n            scrollElementHeight: 0,\n            placeholderHeight: 0,\n            offsetThreshold: [0, 0, 0, 0],\n            cachedSize: new Map(),\n            initialized: false,\n            hasDefaultSize: false,\n            defaultItemSize: 40,\n            lastScrollTop: 0,\n            rearrangeQueue: []\n        };\n    },\n    provide() {\n        return new UTSJSONObject({\n            setCachedSize: (item = null, size) => {\n                if (!this.hasDefaultSize) {\n                    this.defaultItemSize = size;\n                    this.hasDefaultSize = true;\n                }\n                this.cachedSize.set(item, size);\n            }\n        });\n    },\n    created() {\n        this.placeholderHeight = this.list.length * this.defaultItemSize;\n    },\n    mounted() {\n        nextTick(() => {\n            uni.createSelectorQuery().in(this).select('.uni-recycle-view-main').boundingClientRect().exec((ret) => {\n                this.scrollElementHeight = ret[0].height;\n                this.rearrange(0);\n                this.initialized = true;\n            });\n        });\n    },\n    methods: {\n        onScroll(e) {\n            if (!this.initialized) {\n                return null;\n            }\n            const scrollTop = e.detail.scrollTop;\n            if (scrollTop === this.lastScrollTop || scrollTop < 0) {\n                return null;\n            }\n            this.lastScrollTop = scrollTop;\n            if (scrollTop < this.offsetThreshold[1] || scrollTop > this.offsetThreshold[2]) {\n                this.queue(scrollTop);\n            }\n        },\n        queue(scrollTop) {\n            /*\n             * rearrange内为大量同步逻辑，在上次rearrange未执行完毕的情况下将后续多个rearrange合并成一次执行，即仅执行最后一次\n             * 由于滚动机制差异，此优化仅在web端才有意义。\n             * 如何测试：push后uni.__log__('log','at uni_modules/uni-recycle-view/components/uni-recycle-view/uni-recycle-view.uvue:103',this.rearrangeQueue.length) 输出结果大于1时触发优化\n             */\n            this.rearrangeQueue.push(scrollTop);\n            setTimeout(() => {\n                this.flush();\n            }, 1);\n        },\n        flush() {\n            const queueLength = this.rearrangeQueue.length;\n            if (queueLength == 0) {\n                return null;\n            }\n            const lastScrollTop = this.rearrangeQueue[queueLength - 1];\n            this.rearrange(lastScrollTop);\n            this.rearrangeQueue = [];\n        },\n        rearrange(scrollTop) {\n            this.offsetThreshold[0] = Math.max(scrollTop - this.scrollElementHeight * 5, 0);\n            this.offsetThreshold[1] = Math.max(scrollTop - this.scrollElementHeight * 3, 0);\n            this.offsetThreshold[2] = Math.min(scrollTop + this.scrollElementHeight * 4, this.placeholderHeight);\n            this.offsetThreshold[3] = Math.min(scrollTop + this.scrollElementHeight * 6, this.placeholderHeight);\n            const offsetStart = this.offsetThreshold[0];\n            const offsetEnd = this.offsetThreshold[3];\n            const items = [];\n            const defaultItemSize = this.defaultItemSize;\n            const cachedSize = this.cachedSize;\n            const list = this.list;\n            let tempTotalHeight = 0;\n            let containerTop = 0;\n            let start = false, end = false;\n            for (let i = 0; i < list.length; i++) {\n                const item = list[i];\n                let itemSize = defaultItemSize;\n                const cachedItemSize = cachedSize.get(item);\n                if (cachedItemSize != null) {\n                    itemSize = cachedItemSize;\n                }\n                tempTotalHeight += itemSize;\n                if (end) {\n                    continue;\n                }\n                if (tempTotalHeight < offsetStart) {\n                    containerTop = tempTotalHeight;\n                }\n                else if (tempTotalHeight >= offsetStart && tempTotalHeight <= offsetEnd) {\n                    if (start == false) {\n                        start = true;\n                    }\n                    items.push(item);\n                }\n                else {\n                    if (!end) {\n                        end = true;\n                    }\n                }\n            }\n            this.placeholderHeight = tempTotalHeight;\n            this.items = items;\n            this.containerTop = containerTop;\n        }\n    }\n});\n//# sourceMappingURL=/Users/gaoruicheng/Documents/DcloudProject/uniapp-bugs/uniapp-bugs-main/singlePage/uniapp-hello-x/uni_modules/uni-recycle-view/components/uni-recycle-view/uni-recycle-view.uvue?vue&type=script&lang.uts.js.map","references":[],"uniExtApis":["uni.createSelectorQuery"],"map":"{\"version\":3,\"file\":\"uni-recycle-view.uvue?vue&type=script&lang.uts.js\",\"sourceRoot\":\"\",\"sources\":[\"uni-recycle-view.uvue?vue&type=script&lang.uts\"],\"names\":[],\"mappings\":\"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\"}"}
